<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Series Log</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #fff; color:#333; }
        label { display: block; margin-top: 15px; font-weight: 500; font-size: 14px; color: #888; }
        input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-primary { background-color: #3390ec; color: #fff; border: none; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .btn-secondary { background-color: #6c757d; color: #fff; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-total { background-color: #28a745; color: #fff; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; display: none; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .history-box { margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; }
        .total-box { background: #e9f7ef; color: #155724; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 1px solid #c3e6cb; display: none; }
        .item { background-color: #f9f9f9; padding: 12px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; border-left: 4px solid #3390ec; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: #ffcccc; color: red; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 12px; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <h2 style="text-align:center">Series ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏</h2>
    <label>Series Name</label>
    <input list="series-list" id="series" placeholder="·Äá·Ä¨·Äê·Ä∫·ÄÄ·Ä¨·Ä∏ ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·Äæ·Ä¨·Äï·Ä´...">
    <datalist id="series-list"><option value="Loading..."></datalist>
    <label>Episode</label>
    <input type="number" id="episode" placeholder="·Ä°·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ (Eg. 1)">
    <label>Line / Dialog</label>
    <input type="text" id="line" placeholder="·Äá·Ä¨·Äê·Ä∫·Äù·ÄÑ·Ä∫·ÄÖ·ÄÄ·Ä¨·Ä∏">
    
    <button onclick="submitData()" id="btnSave" class="btn-primary">Save Data</button>

    <div class="history-box">
        <button onclick="loadHistory()" id="btnCheck" class="btn-secondary">Check My History</button>
        <button onclick="toggleTotal()" id="btnShowTotal" class="btn-total">Show Total Amount</button>
        <div id="totalDisplay" class="total-box">
            <span style="font-size:14px;">·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äõ·ÄÑ·ÄΩ·Ä±</span><br>
            <b style="font-size:24px;" id="grandTotal">0 MMK</b>
        </div>
        <div id="listArea" style="margin-top:15px;"></div>
    </div>

    <script>
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        const tgUser = window.Telegram.WebApp.initDataUnsafe.user;

        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Script URL (New Version Deploy ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        var scriptURL = "https://script.google.com/macros/s/AKfycbzT7hgWV9WiTfMpXsyRh6tRO4wczCCKL7B5SRRkwwm2CIeeylQjFcC1MGLYaoBxiYU/exec";

        window.onload = function() { fetchLists(); };

        function fetchLists() {
            var fd = new URLSearchParams(); fd.append("action", "getLists");
            fetch(scriptURL, { method: 'POST', body: fd }).then(r => r.json()).then(d => {
                var dl = document.getElementById("series-list"); dl.innerHTML = ""; 
                if (d.series) d.series.forEach(n => { var o = document.createElement("option"); o.value = n; dl.appendChild(o); });
            });
        }

        function submitData() {
            var s = document.getElementById("series").value, e = document.getElementById("episode").value, l = document.getElementById("line").value, btn = document.getElementById("btnSave");
            if (!s || !e) { window.Telegram.WebApp.showAlert("Series ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ Episode ·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
            btn.innerText = "Saving..."; btn.disabled = true;
            var fd = new URLSearchParams();
            fd.append("series", s); fd.append("episode", e); fd.append("line", l || "-");
            fd.append("username", tgUser ? tgUser.username : "N/A"); fd.append("userid", tgUser ? tgUser.id : "N/A");
            fetch(scriptURL, { method: 'POST', body: fd }).then(r => r.json()).then(d => {
                window.Telegram.WebApp.showAlert("‚úÖ Saved!\nTotal: " + Number(d.total_amount).toLocaleString() + " MMK");
                document.getElementById("series").value = ""; document.getElementById("episode").value = ""; document.getElementById("line").value = "";
                btn.innerText = "Save Data"; btn.disabled = false;
            }).catch(err => { window.Telegram.WebApp.showAlert("Error: " + err); btn.innerText = "Save Data"; btn.disabled = false; });
        }

        function loadHistory() {
            var btn = document.getElementById("btnCheck"), list = document.getElementById("listArea"), btnTotal = document.getElementById("btnShowTotal"), totalBox = document.getElementById("totalDisplay");
            btn.innerText = "Loading..."; btn.disabled = true; list.innerHTML = ""; btnTotal.style.display = "none"; totalBox.style.display = "none";
            btnTotal.innerText = "Show Total Amount"; btnTotal.style.backgroundColor = "#28a745";

            var fd = new URLSearchParams(); fd.append("action", "read"); fd.append("userid", tgUser ? tgUser.id : "0");
            fetch(scriptURL, { method: 'POST', body: fd }).then(r => r.json()).then(data => {
                btn.innerText = "Refresh History"; btn.disabled = false;
                var history = data.history || [], total = data.total_amount || 0;
                if (history.length === 0) { list.innerHTML = "<p style='text-align:center'>Data ·Äô·Äõ·Äæ·Ä≠·Äï·Ä´</p>"; return; }
                document.getElementById("grandTotal").innerText = Number(total).toLocaleString() + " MMK";
                btnTotal.style.display = "block";
                list.innerHTML = `<p style='text-align:center;color:gray;font-size:12px'>${history.length} ·ÄÅ·ÄØ ·Äê·ÄΩ·Ä±·Ä∑·Äû·Ää·Ä∫</p>`;
                history.forEach(item => {
                    var div = document.createElement("div"); div.className = "item";
                    // Encode data to prevent quotes issue
                    var sEnc = encodeURIComponent(item.series), eEnc = encodeURIComponent(item.episode), lEnc = encodeURIComponent(item.line);
                    
                    div.innerHTML = `
                        <button class="btn-delete" onclick="deleteData('${sEnc}', '${eEnc}', '${lEnc}', this)">üóëÔ∏è</button>
                        
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px; padding-right: 30px;">
                            <strong style="color:#3390ec; font-size:15px;">${item.series}</strong>
                            <span style="font-weight:bold; color:#555;">Ep: ${item.episode}</span>
                        </div>
                        <div style="font-size:13px; color:#333; background:#fff; padding:8px; border-radius:6px; border:1px solid #e0e0e0;">
                            Line: ${item.line} <span style="color:#aaa;">|</span> Rate: ${item.rate} <span style="color:#aaa;">=</span> 
                            <span style="color:#28a745; font-weight:bold;">${Number(item.sum).toLocaleString()}</span>
                        </div><div style="font-size:10px; color:#aaa; text-align:right; margin-top:5px;">${item.date}</div>`;
                    list.appendChild(div);
                });
            }).catch(e => {
                btn.innerText = "Check My History"; btn.disabled = false;
                list.innerHTML = "<p style='color:red;text-align:center'>Connection Error</p>";
            });
        }

        function toggleTotal() {
            var box = document.getElementById("totalDisplay"), btn = document.getElementById("btnShowTotal");
            if (box.style.display === "none") { box.style.display = "block"; btn.innerText = "Hide Total Amount"; btn.style.backgroundColor = "#dc3545"; } 
            else { box.style.display = "none"; btn.innerText = "Show Total Amount"; btn.style.backgroundColor = "#28a745"; }
        }

        function deleteData(s, e, l, btnElement) {
            // Decode back the data
            var series = decodeURIComponent(s);
            var ep = decodeURIComponent(e);
            var line = decodeURIComponent(l);

            if(!confirm("·Äñ·Äª·ÄÄ·Ä∫·Äô·Äæ·Ä¨ ·Äû·Ä±·ÄÅ·Äª·Ä¨·Äï·Ä´·Äû·Äú·Ä¨·Ä∏?\n\n" + series + " - Ep " + ep)) return;
            
            // ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·ÄÅ·Äè ·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫ (Loading ·Äï·ÄØ·Ä∂·ÄÖ·Ä∂·Äï·Äº·Äô·Äö·Ä∫)
            var originalText = btnElement.innerText;
            btnElement.innerText = "‚è≥";
            btnElement.disabled = true;

            var fd = new URLSearchParams(); 
            fd.append("action", "delete"); 
            fd.append("userid", tgUser ? tgUser.id : "0");
            fd.append("series", series); 
            fd.append("episode", ep); 
            fd.append("line", line);

            fetch(scriptURL, { method: 'POST', body: fd })
            .then(r => r.json())
            .then(d => {
                if(d.status == "deleted") {
                    // ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫ Popup ·Ä°·Äû·Ä±·Ä∏·Äú·Ä±·Ä∏·Äï·Äº·Äï·Äº·ÄÆ·Ä∏ Refresh ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                    window.Telegram.WebApp.showAlert("‚úÖ ·Äñ·Äª·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ");
                    loadHistory(); 
                } else if (d.status == "not_found") {
                    window.Telegram.WebApp.showAlert("‚ùå Data ·Äô·Äê·ÄΩ·Ä±·Ä∑·Äï·Ä´ (·Äû·Ä≠·ÄØ·Ä∑) ·Äñ·Äª·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏ ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äï·Ä´·Äô·Ää·Ä∫·Åã");
                    loadHistory(); // Refresh ·Äú·ÄØ·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫
                } else {
                    window.Telegram.WebApp.showAlert("‚ùå Error: " + d.message);
                    // Error ·Äê·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Äï·Äº·Äî·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äô·Äö·Ä∫
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }
            })
            .catch(err => {
                window.Telegram.WebApp.showAlert("Connection Error: " + err);
                btnElement.innerText = originalText;
                btnElement.disabled = false;
            });
        }
    </script>
</body>
</html>